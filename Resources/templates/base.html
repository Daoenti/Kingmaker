<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Kingmaker Campaign{% endblock %}</title>
    <link rel="stylesheet" href="{{ base_url }}/base.css">
    <link rel="stylesheet" href="{{ base_url }}/theme-gruvbox-dark.css" id="theme-stylesheet">
    <script>
        // Theme management
        function changeTheme(theme) {
            const stylesheet = document.getElementById('theme-stylesheet');
            stylesheet.href = '{{ base_url }}/' + theme;
            localStorage.setItem('selectedTheme', theme);
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'theme-gruvbox-dark.css';
            const stylesheet = document.getElementById('theme-stylesheet');
            stylesheet.href = '{{ base_url }}/' + savedTheme;

            // Update select element
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = savedTheme;
            }
        });
    </script>
    <script>
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = event.currentTarget.querySelector('.toggle-icon');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '▼';
            } else {
                section.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function loadContent(url, title) {
            // Save sidebar scroll position
            const nav = document.querySelector('nav');
            if (nav) {
                sessionStorage.setItem('sidebarScroll', nav.scrollTop);
            }

            // Convert regular URL to content URL
            const contentUrl = url.replace('.html', '-content.html');

            fetch(contentUrl)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('main').innerHTML = html;
                    document.title = title + ' - Kingmaker Campaign';
                    window.history.pushState({}, '', url);

                    // Restore sidebar scroll position
                    const scrollPos = sessionStorage.getItem('sidebarScroll');
                    if (nav && scrollPos) {
                        nav.scrollTop = parseInt(scrollPos);
                    }

                    // Intercept links in the newly loaded content
                    interceptContentLinks();

                    // Make content sections collapsible
                    makeContentCollapsible();
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    window.location.href = url;
                });
        }

        function interceptContentLinks() {
            const main = document.querySelector('main');
            if (!main) return;

            main.querySelectorAll('a[href]').forEach(link => {
                const href = link.getAttribute('href');
                // Only intercept internal links to .html files
                if (href && href.includes('.html') && !href.startsWith('http')) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const url = this.getAttribute('href');
                        const title = this.textContent;
                        loadContent(url, title);
                    });
                }
            });
        }

        function makeContentCollapsible() {
            const main = document.querySelector('main');
            if (!main) return;

            // Find all h2 headers in main content
            const headers = main.querySelectorAll('h2');

            headers.forEach(header => {
                // Skip if already collapsible
                if (header.classList.contains('collapsible-content')) return;

                // Make header collapsible
                header.classList.add('collapsible-content');
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';

                // Add toggle icon
                const icon = document.createElement('span');
                icon.className = 'content-toggle-icon';
                icon.textContent = '▼';
                header.insertBefore(icon, header.firstChild);
                header.insertBefore(document.createTextNode(' '), header.childNodes[1]);

                // Create wrapper for content after this header
                const wrapper = document.createElement('div');
                wrapper.className = 'collapsible-section';

                // Collect all elements until next h2 or h1
                let sibling = header.nextElementSibling;
                while (sibling && sibling.tagName !== 'H2' && sibling.tagName !== 'H1') {
                    const next = sibling.nextElementSibling;
                    wrapper.appendChild(sibling);
                    sibling = next;
                }

                // Insert wrapper after header
                header.parentNode.insertBefore(wrapper, header.nextSibling);

                // Add click handler
                header.addEventListener('click', function() {
                    const section = this.nextElementSibling;
                    const toggleIcon = this.querySelector('.content-toggle-icon');

                    if (section.style.display === 'none') {
                        section.style.display = 'block';
                        toggleIcon.textContent = '▼';
                    } else {
                        section.style.display = 'none';
                        toggleIcon.textContent = '▶';
                    }
                });
            });
        }

        function expandAll() {
            const main = document.querySelector('main');
            if (!main) return;

            main.querySelectorAll('.collapsible-section').forEach(section => {
                section.style.display = 'block';
            });
            main.querySelectorAll('.content-toggle-icon').forEach(icon => {
                icon.textContent = '▼';
            });
        }

        function collapseAll() {
            const main = document.querySelector('main');
            if (!main) return;

            main.querySelectorAll('.collapsible-section').forEach(section => {
                section.style.display = 'none';
            });
            main.querySelectorAll('.content-toggle-icon').forEach(icon => {
                icon.textContent = '▶';
            });
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function() {
            location.reload();
        });

        // Restore sidebar scroll position on page load
        window.addEventListener('DOMContentLoaded', function() {
            const nav = document.querySelector('nav');
            const scrollPos = sessionStorage.getItem('sidebarScroll');
            if (nav && scrollPos) {
                nav.scrollTop = parseInt(scrollPos);
            }

            // Intercept links in initial content
            interceptContentLinks();

            // Make initial content collapsible
            makeContentCollapsible();
        });
    </script>
</head>
<body>
    <div class="container">
        {{ navigation|safe }}
        <main>
            {% block content %}{% endblock %}
        </main>
    </div>
</body>
</html>
